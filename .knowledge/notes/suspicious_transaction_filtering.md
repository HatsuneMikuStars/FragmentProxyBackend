# Реализация фильтрации подозрительных транзакций

## [2023-11-29 15:30] Добавление параметра filterSuspicious в getTransactions

### Описание решения

Добавлен новый параметр `filterSuspicious` в интерфейс `GetTransactionsParams` для фильтрации подозрительных (спам) транзакций в методе `getTransactions`. При установке параметра в `true`, в результате запроса не будут отображаться транзакции, классифицированные как спам.

### Технические детали

1. **Интерфейс GetTransactionsParams**

Добавлен новый опциональный параметр:

```typescript
/**
 * Фильтрация подозрительных (спам) транзакций
 * Если true, подозрительные транзакции будут исключены из результата
 * (по умолчанию false)
 */
filterSuspicious?: boolean;
```

2. **Метод getTransactions**

В методе добавлена логика фильтрации подозрительных транзакций с использованием существующего метода `isSuspiciousTransaction`:

```typescript
// Фильтрация подозрительных транзакций, если требуется
if (filterSuspicious) {
  result = result.filter(tx => !this.isSuspiciousTransaction(tx));
}
```

### Пример использования

```typescript
// Получение всех транзакций (включая спам)
const allTransactions = await tonWalletService.getTransactions({
  limit: 20,
  archival: true,
  type: TransactionType.INCOMING
});

// Получение транзакций без спама
const filteredTransactions = await tonWalletService.getTransactions({
  limit: 20,
  archival: true,
  type: TransactionType.INCOMING,
  filterSuspicious: true
});
```

### Критерии определения подозрительных транзакций

Метод `isSuspiciousTransaction` определяет транзакцию как подозрительную, если:

1. Комментарий начинается с символа "@" (независимо от суммы)
2. Сумма транзакции меньше или равна 0.01 TON (в нано-единицах) И содержит другой подозрительный комментарий
3. Транзакция имеет признак "bounce" (отскок)
4. Транзакция не содержит комментария или комментарий пустой

Подозрительные паттерны в комментариях включают:
- URL-ссылки
- Ссылки на Telegram
- Ключевые слова связанные с мошенничеством (airdrop, free, giveaway, claim)
- Ложные сообщения о получении средств
- Обещания выигрыша
- Попытки убедить пользователя подключить кошелек
- Комментарии, начинающиеся с "@" (считаются подозрительными независимо от суммы)

## [2023-11-29 16:45] Обновление логики обнаружения подозрительных транзакций

### Изменения

Обновлена логика метода `isSuspiciousTransaction` для выявления комментариев, начинающихся с символа "@". Такие комментарии теперь считаются подозрительными независимо от суммы транзакции.

До изменения:
- Транзакция считалась подозрительной, только если имела маленькую сумму И подозрительный комментарий.

После изменения:
- Транзакции с комментариями, начинающимися с "@", считаются подозрительными всегда.
- Остальные подозрительные паттерны учитываются только в сочетании с маленькой суммой.

Это изменение позволит эффективнее фильтровать спам-транзакции, где комментарий содержит упоминание пользователя (например: "@username").

## [2023-11-29 18:15] Добавление фильтрации транзакций без комментария

### Изменения

Обновлена логика метода `isSuspiciousTransaction` для выявления транзакций без комментария. Теперь транзакции, в которых отсутствует комментарий или комментарий является пустой строкой, также считаются подозрительными.

```typescript
// Проверка на отсутствие комментария
const hasNoComment = !transaction.comment || transaction.comment.trim() === '';

// ...

// Добавлено условие в итоговую проверку
return isAtTagComment || (isSmallAmount && hasOtherSuspiciousPattern) || isBouncePattern === true || hasNoComment;
```

Это изменение улучшит качество фильтрации транзакций за счет исключения "безмолвных" переводов, не содержащих информации о назначении платежа.

## Альтернативный подход

В системе уже существует метод `getTransactionsWithSuspiciousCheck`, который возвращает как все транзакции, так и отдельно список подозрительных транзакций. Новая реализация через параметр `filterSuspicious` в `getTransactions` является более простым в использовании аналогом для случаев, когда нужно просто отфильтровать нежелательные транзакции. 