# База знаний о проекте FragmentProxyBackend

## [2023-11-29 12:00] Общее описание системы

### Архитектура и назначение проекта

FragmentProxyBackend — это система-посредник между пользователями и платформой Fragment, предназначенная для автоматической покупки звезд Telegram. Основной сценарий работы:

1. Пользователь отправляет TON на кошелек системы с комментарием, содержащим имя пользователя Telegram
2. Система мониторит входящие транзакции, обнаруживает новую и обрабатывает её
3. Система конвертирует TON в звезды согласно текущему курсу и покупает их для указанного пользователя
4. Результат транзакции сохраняется в базе данных

### Ключевые компоненты системы:

1. **TonWalletService** — сервис для работы с TON кошельком
2. **TonTransactionMonitor** — сервис мониторинга транзакций
3. **FragmentStarsPurchaseService** — сервис покупки звезд на платформе Fragment
4. **TransactionRepository** — репозиторий для работы с БД транзакций

---

## [2023-11-29 12:15] Система обработки транзакций

### Статусы транзакций

В системе используется четыре статуса для отслеживания жизненного цикла транзакции:

1. **pending** — Транзакция прошла валидацию и ожидает обработки
2. **processing** — Транзакция в процессе обработки (статус блокировки)
3. **processed** — Транзакция успешно обработана
4. **failed** — Обработка завершилась с ошибкой

### Механизм блокировок

Для предотвращения одновременной обработки одной транзакции несколькими экземплярами сервиса используется механизм блокировок через статус "processing". Реализация включает методы:

- `lockTransaction` — блокирует транзакцию для обработки
- `unlockTransaction` — разблокирует транзакцию, меняя статус на "pending" или "failed"

Структура системы блокировок:
```
Транзакция (pending) ──> Блокировка (processing) ──> Обработка ──> Результат:
                                                                    ├─> Успех (processed)
                                                                    ├─> Ошибка (failed)
                                                                    └─> Прерывание (возврат в pending)
```

### Обработка ошибок

Система различает два типа ошибок:

1. **Неисправимые ошибки** (non-retryable):
   - Неверное имя пользователя
   - Количество звезд меньше минимального порога (50 звезд)
   - Количество звезд больше максимального лимита
   - Другие ошибки бизнес-логики

2. **Исправимые ошибки** (retryable):
   - Временная недоступность сервиса Fragment
   - Сетевые ошибки
   - Недоступность кошелька

---

## [2023-11-29 12:30] TonWalletService

### Функциональность сервиса

TonWalletService отвечает за:
1. Инициализацию кошелька TON
2. Получение баланса и транзакций
3. Отправку транзакций
4. Работу с API TON

### Типы транзакций TON

В TON существует три типа транзакций, которые обрабатывает сервис:

1. **incoming** — входящие транзакции (перевод TON на кошелек системы)
2. **outgoing** — исходящие транзакции (покупка звезд, переводы)
3. **unknown** — служебные транзакции блокчейна (не связанные с переводами TON)

Транзакции с типом "unknown" характеризуются:
- Нулевой суммой перевода (`amount: 0n`)
- Отсутствием комментария (`comment: undefined`)
- Пустыми полями отправителя и получателя
- Наличием только комиссии сети (обычно `fee: ~2048000n`)

Эти транзакции представляют собой системные сообщения TON:
- Взаимодействия между смарт-контрактами
- События TON Virtual Machine
- Сообщения шардинга
- Bounce-сообщения

### Метод getTransactions

Метод `getTransactions` принимает следующие параметры:
```typescript
interface GetTransactionsParams {
  limit?: number;        // Ограничение количества транзакций
  lt?: string;           // Логическое время (для пагинации)
  hash?: string;         // Хеш транзакции
  to_lt?: string;        // Конечное логическое время
  archival?: boolean;    // Использовать архивные ноды
  type?: 'incoming' | 'outgoing' | 'unknown'; // Тип транзакции для фильтрации
}
```

Для получения только входящих транзакций (которые требуются для мониторинга) используется параметр `type: 'incoming'`.

---

## [2023-11-29 12:45] FragmentStarsPurchaseService

### Функциональность сервиса

FragmentStarsPurchaseService отвечает за:
1. Поиск пользователя Fragment по имени
2. Получение текущего курса TON к звездам
3. Покупку звезд для указанного пользователя
4. Мониторинг статуса транзакции в Fragment

### Основные методы

1. **findRecipientIdAsync** — поиск ID получателя по имени пользователя
2. **getStarsExchangeRate** — получение текущего курса обмена TON на звезды
3. **purchaseStarsAsync** — покупка звезд для пользователя
4. **checkPurchaseStatusWithPollingAsync** — проверка статуса покупки с поллингом

### Интеграция с Fragment API

Сервис использует HTTP-запросы к API Fragment для выполнения операций:
- Авторизация через cookies
- Поиск пользователей
- Получение курса обмена
- Создание транзакции покупки
- Проверка статуса транзакции

---

## [2023-11-29 13:00] Структура базы данных

### Основные таблицы

1. **transactions** — хранит информацию о всех обработанных транзакциях:
   - hash (PK) — хеш транзакции в блокчейне TON
   - amount — сумма транзакции в TON
   - gasFee — комиссия за газ
   - amountAfterGas — сумма после вычета газа
   - exchangeRate — курс обмена TON на звезды
   - senderAddress — адрес отправителя
   - comment — комментарий к транзакции
   - username — извлеченное имя пользователя Telegram
   - starsAmount — количество купленных звезд
   - fragmentTransactionHash — хеш транзакции в системе Fragment
   - status — статус обработки ('pending', 'processing', 'processed', 'failed')
   - errorMessage — сообщение об ошибке (если есть)
   - createdAt/updatedAt — временные метки

### Примеры SQL-запросов

1. Получение статистики транзакций:
```sql
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN status = 'processed' THEN 1 ELSE 0 END) as processed,
  SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) as failed,
  SUM(CASE WHEN status = 'pending' THEN 1 ELSE 0 END) as pending,
  SUM(CASE WHEN status = 'processing' THEN 1 ELSE 0 END) as processing
FROM transactions;
```

2. Получение общей суммы обработанных TON:
```sql
SELECT SUM(amount) as total_ton FROM transactions WHERE status = 'processed';
```

---

## [2023-11-29 13:15] Системные требования и конфигурация

### Зависимости проекта

1. **TypeScript/Node.js** — основная платформа разработки
2. **TON SDK** — для работы с блокчейном TON
3. **axios** — для HTTP-запросов к Fragment API
4. **TypeORM/SQLite** — для работы с базой данных
5. **winston** — для логирования

### Файлы конфигурации

Основные параметры системы находятся в `src/config.ts`:

1. **TON_WALLET_CONFIG** — конфигурация кошелька TON:
   - mnemonic — мнемоническая фраза для восстановления кошелька
   - subwalletId — ID подкошелька
   - useTestnet — использовать тестовую сеть
   - apiUrl — URL API-ноды TON
   - apiKey — ключ доступа к API

2. **TRANSACTION_MONITOR_CONFIG** — конфигурация монитора транзакций:
   - CHECK_INTERVAL_MS — интервал проверки новых транзакций (мс)
   - MIN_STARS — минимальное количество звезд для покупки
   - MAX_STARS — максимальное количество звезд для покупки

3. **FRAGMENT_API_CONFIG** — конфигурация API Fragment:
   - COOKIES — куки для авторизации в Fragment
   - BASE_URL — базовый URL API Fragment

---

## [2023-11-29 13:30] Возможные улучшения системы

### Улучшения архитектуры

1. **Модульная структура** — разделение TonTransactionMonitor на отдельные модули:
   - TransactionMonitor — основной координатор
   - TransactionProcessor — обработка транзакций
   - TransactionValidator — валидация транзакций
   - TransactionLockManager — управление блокировками
   - ErrorCategorizer — категоризация ошибок
   - StarsCalculator — расчет количества звезд

2. **Улучшение API** — добавление RESTful API:
   - Получение статистики транзакций
   - Ручная обработка транзакций
   - Проверка статуса транзакции
   - Управление системой

### Улучшения надежности

1. **Мониторинг и метрики**:
   - Prometheus для сбора метрик
   - Grafana для визуализации
   - Алерты при критических ошибках

2. **Улучшенное логирование**:
   - Структурированные логи
   - Ротация логов
   - Централизованное хранение логов

3. **Механизм восстановления**:
   - Автоматическое восстановление после сбоев
   - Периодическая проверка транзакций со статусом "processing"
   - Резервное копирование БД

### Функциональные улучшения

1. **Расширенные возможности покупки**:
   - Поддержка других услуг Fragment (не только звезды)
   - Возможность указания произвольного получателя
   - Поддержка промокодов и скидок

2. **Улучшение UX**:
   - Уведомления пользователей о статусе транзакции
   - Интеграция с Telegram Bot API для проверки статуса
   - Веб-интерфейс для мониторинга 