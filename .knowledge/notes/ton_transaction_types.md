# Типы транзакций в блокчейне TON

## [2023-11-29 14:00] Подробный анализ типов транзакций

### Общая классификация транзакций

В блокчейне TON (The Open Network) транзакции делятся на следующие основные типы:

1. **Обычные переводы средств**:
   - **incoming** — входящие транзакции (получение TON)
   - **outgoing** — исходящие транзакции (отправка TON)

2. **Системные сообщения**:
   - **unknown** — служебные сообщения блокчейна
   - **bounce** — возврат средств при ошибке транзакции
   - **deploy** — развертывание смарт-контрактов

3. **Сообщения смарт-контрактов**:
   - Внутренние сообщения между контрактами
   - Вызовы Get-методов (чтение данных)
   - Вызовы методов смарт-контрактов с изменением состояния

### Детальное описание транзакций типа "unknown"

Транзакции с типом "unknown" в сервисе TonWalletService имеют особый характер:

```javascript
{
  id: '55351624000003_\x1B!�3p��:�Yg�C�W�%o�ڕ\x1D;�\x0EÒy�\x18d�',
  type: 'unknown',
  timestamp: 1742917308,
  lt: '55351624000003',
  hash: <Buffer ...>,
  fromAddress: '',
  toAddress: '',
  amount: 0n,
  fee: 2048000n,
  comment: undefined,
  status: 'completed',
  additionalData: { utime: 1742917308 }
}
```

#### Характеристики:
1. **Нулевая сумма** (`amount: 0n`) — не переносят TON между кошельками
2. **Отсутствие адресов** (`fromAddress: '', toAddress: ''`) — не имеют явного отправителя/получателя
3. **Комиссия сети** (`fee: ~2048000n`) — потребляют газ для выполнения
4. **Отсутствие комментария** (`comment: undefined`) — не содержат пользовательской информации

#### Технические причины:

1. **Фазы вычислений в TON**:
   TON использует многофазную модель транзакций, где каждая фаза может генерировать отдельные записи в блокчейне.

2. **Внутренние сообщения контрактов**:
   Смарт-контракты обмениваются сообщениями, которые не являются переводами TON, но записываются в блокчейн.

3. **Шардинг и маршрутизация**:
   TON использует шардинг для масштабирования, и системные сообщения между шардами могут отображаться как "unknown".

4. **Опкоды и формат сообщений**:
   SDK не распознает определенные опкоды или форматы данных сообщений TON и маркирует их как "unknown".

### Обработка транзакций в системе Fragment Proxy

В контексте системы Fragment Proxy Backend:

1. **incoming** — основной тип для обработки, эти транзакции содержат TON, отправленный пользователями для покупки звезд.

2. **outgoing** — транзакции, которые система создает для покупки звезд на Fragment.

3. **unknown** — эти транзакции полностью игнорируются системой, так как:
   - Не содержат TON для конвертации в звезды
   - Не имеют комментария с именем пользователя Telegram
   - Являются техническими операциями блокчейна

#### Рекомендованный подход к фильтрации:

```typescript
// Фильтрация на уровне запроса транзакций
const incomingTransactions = await walletService.getTransactions({
  limit: 20,
  archival: true,
  type: 'incoming' // Получаем только входящие транзакции
});

// Дополнительная проверка в коде на всякий случай
if (tx.type !== 'incoming' || !tx.comment) {
  console.log(`[Monitor] Скипуем не входящую транзакцию: ${tx.id}, тип: ${tx.type}`);
  return;
}
```

### Технические детали TON SDK

TON SDK определяет тип транзакции на основе следующих факторов:

1. **Наличие входящего сообщения** — если есть входящее сообщение с суммой > 0
2. **Направление** — сравнение адреса кошелька с адресами отправителя/получателя
3. **Тип сообщения** — определяется по опкодам и структуре данных

### Таблица опкодов TON

| Опкод (hex) | Описание                    | Тип в TonWalletService |
|------------|----------------------------|------------------------|
| 0x0        | Обычный перевод             | incoming/outgoing      |
| 0x1        | Внутреннее сообщение        | unknown                |
| 0x2        | Bounce-сообщение            | incoming/unknown       |
| 0x5        | Deploy-сообщение            | unknown/outgoing       |
| 0xFFFFFFFF | Системное сообщение         | unknown                |

---

## [2023-11-29 14:15] Практические рекомендации

### Индексация транзакций

Для эффективного мониторинга транзакций рекомендуется:

1. **Фильтровать по типу на ранних этапах**:
   ```typescript
   // В TonWalletService
   if (params?.type) {
     return walletTransactions.filter(tx => tx.type === params.type);
   }
   ```

2. **Логировать необычные типы транзакций**:
   ```typescript
   if (tx.type === 'unknown' && tx.fee > 5000000n) {
     console.log(`[Monitor] Необычно высокая комиссия для unknown-транзакции: ${tx.fee}, хеш: ${tx.id}`);
   }
   ```

3. **Использовать архивные ноды для полной истории**:
   ```typescript
   const allTransactions = await this.walletService.getTransactions({
     limit: 100,
     archival: true, // Важно для получения полной истории
     type: 'incoming'
   });
   ```

### Потенциальные проблемы и решения

1. **Проблема**: Потеря транзакций при фильтрации
   **Решение**: Логирование количества всех транзакций и количества после фильтрации

2. **Проблема**: Неправильное определение типа транзакции
   **Решение**: Вторичная проверка по сумме и адресам

3. **Проблема**: Системные транзакции с ненулевой суммой
   **Решение**: Всегда проверять наличие комментария и валидировать его формат 