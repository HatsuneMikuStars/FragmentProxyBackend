# API для расчета стоимости звезд Fragment в TON и USD

## [2023-08-16 16:30] Разработка API для конвертации звезд в TON/USD

### Обзор
Добавлен новый API эндпоинт для получения актуальной стоимости звезд Fragment в TON и USD. Это позволяет пользователям узнать, сколько будет стоить определенное количество звезд перед совершением транзакции.

### Структура API
Эндпоинт: `GET /api/stars/price`

#### Параметры запроса
- `amount` (обязательный) - количество звезд, для которого нужно рассчитать стоимость

#### Пример запроса
```
GET /api/stars/price?amount=500
```

#### Формат ответа
```json
{
  "success": true,
  "data": {
    "starsAmount": 500,
    "tonPrice": 6.345678,
    "gasFee": 0.004000,
    "totalTonPrice": 6.349678,
    "usdPrice": 47.59,
    "totalUsdPrice": 47.62,
    "tonToUsdRate": 7.5,
    "starsPerTon": 78.79,
    "minStars": 50,
    "maxStars": 1000000
  }
}
```

#### Поля ответа
- `starsAmount` - запрошенное количество звезд
- `tonPrice` - стоимость звезд в TON
- `gasFee` - комиссия за газ в TON
- `totalTonPrice` - полная стоимость в TON (включая комиссию за газ)
- `usdPrice` - стоимость звезд в долларах США (приблизительная)
- `totalUsdPrice` - полная стоимость в USD (включая комиссию за газ)
- `tonToUsdRate` - текущий курс обмена TON к USD
- `starsPerTon` - текущий курс обмена TON на звезды (количество звезд за 1 TON)
- `minStars` - минимальное количество звезд, которое можно купить
- `maxStars` - максимальное количество звезд, которое можно купить

#### Возможные ошибки
- `400 Bad Request` - неверные параметры запроса (например, отрицательное количество звезд)
- `500 Internal Server Error` - внутренняя ошибка сервера

#### Пример ошибки
```json
{
  "success": false,
  "error": "Минимальное количество звезд для покупки: 50",
  "data": {
    "starsAmount": 10,
    "tonPrice": 0,
    "gasFee": 0,
    "totalTonPrice": 0,
    "usdPrice": null,
    "totalUsdPrice": null,
    "tonToUsdRate": null,
    "starsPerTon": 0,
    "minStars": 50,
    "maxStars": 1000000
  }
}
```

### Архитектура реализации

Для реализации API были созданы следующие компоненты:

1. **TonPriceService** - сервис для получения актуального курса TON к USD:
   - Использует CoinGecko API в качестве основного источника данных
   - Имеет запасной вариант с Binance API
   - Кэширует результаты на 5 минут для снижения нагрузки на внешние API

2. **StarsPriceCalculatorService** - сервис для расчета стоимости звезд:
   - Получает курс обмена TON на звезды из Fragment API
   - Рассчитывает стоимость в TON
   - Учитывает комиссию за газ из конфигурации
   - Рассчитывает полную стоимость (включая комиссию)
   - Преобразует стоимость в USD с помощью TonPriceService
   - Возвращает полную информацию о расчетах

3. **API маршрут** - обрабатывает запросы от клиентов:
   - Валидирует входные параметры
   - Создает необходимые сервисы
   - Форматирует результаты для ответа

### Особенности работы
- Курс TON/USD обновляется каждые 5 минут
- Курс TON/звезды запрашивается напрямую из Fragment API при каждом запросе
- API работает даже если не удается получить курс TON/USD (в этом случае поле usdPrice будет null)
- Комиссия за газ берется из конфигурации TRANSACTION_MONITOR_CONFIG.GAS_FEE

### ASCII-диаграмма процесса расчета цены

```
Клиент                     API                  Fragment API         Внешние API
  |                         |                        |                    |
  | --- GET /stars/price--->|                        |                    |
  |                         |                        |                    |
  |                         |---getStarsExchangeRate->                    |
  |                         |                        |                    |
  |                         |<--------starsPerTon----|                    |
  |                         |                        |                    |
  |                         |----------getTonToUsdRate----------------->  |
  |                         |                        |                    |
  |                         |<-----------usdRate-----|                    |
  |                         |                        |                    |
  |                         |-[Расчет стоимости с    |                    |
  |                         |  учетом газа]          |                    |
  |                         |                        |                    |
  |<---- JSON response -----|                        |                    |
```

### Тестирование
API было протестировано с различными параметрами:
- Положительные и отрицательные значения количества звезд
- Значения ниже минимального порога (50 звезд)
- Значения выше максимального порога (1000000 звезд)
- Нечисловые значения

## [2023-08-17 10:30] Добавление информации о комиссии и полной стоимости

### Изменения
- Добавлена информация о комиссии за газ (`gasFee`)
- Добавлен расчет полной стоимости в TON (`totalTonPrice`)
- Добавлен расчет полной стоимости в USD (`totalUsdPrice`)
- Комиссия берется из стандартной конфигурации TRANSACTION_MONITOR_CONFIG.GAS_FEE (обычно 0.004 TON)
- Обновлены все соответствующие ответы API и документация 