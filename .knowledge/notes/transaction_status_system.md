## [2023-11-28 15:30] Система статусов транзакций FragmentProxyBackend

### Жизненный цикл транзакций

В системе FragmentProxyBackend транзакции проходят через следующие статусы:

1. **pending** — Начальный статус
   - Транзакция прошла валидацию (проверка комментария, имени пользователя, количества звезд)
   - Сохранена в базу данных
   - Готова к обработке, но ещё не взята в работу
   - Может быть повторно обработана при необходимости

2. **processing** — Статус блокировки
   - Транзакция активно обрабатывается в данный момент 
   - Служит механизмом блокировки для предотвращения одновременной обработки
   - Защищает от дублирования транзакций при работе нескольких экземпляров сервиса
   - Временный статус, не предназначен для долгого хранения

3. **processed** — Финальный успешный статус
   - Транзакция успешно обработана
   - Звезды отправлены пользователю через Fragment API
   - Сохранен идентификатор транзакции в Fragment (fragmentTransactionHash)
   - Не будет обрабатываться повторно

4. **failed** — Финальный статус ошибки
   - Обработка завершилась с ошибкой
   - Сохранено сообщение об ошибке (errorMessage)
   - Может быть доступна для повторной обработки в зависимости от типа ошибки

### Механизм блокировок

```
Транзакция (pending) ──> Блокировка (processing) ──> Обработка ──> Результат:
                                                                    ├─> Успех (processed)
                                                                    ├─> Ошибка (failed)
                                                                    └─> Прерывание (возврат в pending)
```

Блокировка реализована через обновление статуса транзакции на "processing" и последующую разблокировку при завершении обработки.

Важный момент: если процесс обработки прерывается (например, при аварийном завершении сервера), транзакции не "застревают" в статусе "processing", а возвращаются в статус "pending" при следующем запуске, что обеспечивает отказоустойчивость системы.

### Ключевые файлы и методы

- **src/database/entities/transaction.entity.ts**: определение сущности транзакции
- **src/services/tonTransactionMonitor.ts**: логика обработки и смены статусов
- **src/database/repositories/transaction.repository.ts**: методы работы с БД

### Реализация в коде

Блокировка транзакции:
```typescript
await this.repository.update(
  { hash, status: tx.status },
  { status: 'processing', errorMessage: null }
);
```

Разблокировка транзакции:
```typescript
const newStatus = errorMessage ? 'failed' : 'pending';
await this.repository.update(
  { hash, status: 'processing' },
  { status: newStatus, errorMessage: errorMessage || tx.errorMessage }
);
```

---

## [2023-11-28 15:45] Обработка ошибок и повторные попытки

Система различает два типа ошибок:

1. **Неисправимые ошибки** (non-retryable):
   - Неверное имя пользователя
   - Количество звезд меньше минимального порога (50 звезд)
   - Количество звезд больше максимального лимита
   - Другие ошибки бизнес-логики, которые не будут исправлены при повторе

2. **Исправимые ошибки** (retryable):
   - Временная недоступность сервиса Fragment
   - Сетевые ошибки
   - Недоступность кошелька
   - Другие временные технические проблемы

При обработке транзакции со статусом "failed" система проверяет тип ошибки и принимает решение о повторной обработке:

```typescript
// Проверка на неисправимые ошибки
const nonRetryableErrors = [
  'Username not found',
  'Invalid username',
  'Stars amount below minimum threshold',
  'Stars amount exceeds maximum limit'
];

// Если ошибка неисправимая - пропускаем транзакцию
if (errorMessage && nonRetryableErrors.some(err => errorMessage.includes(err))) {
  console.log(`[Monitor] Пропуск повторной обработки транзакции ${hash} из-за неисправимой ошибки: ${errorMessage}`);
  return;
}

// Для исправимых ошибок - пытаемся обработать снова
console.log(`[Monitor] Повторная обработка транзакции ${hash} со статусом 'failed'`);
```

Это обеспечивает эффективную работу системы, предотвращая бесконечные повторные попытки для заведомо неисправимых ошибок. 

## [2023-11-28 17:20] Реализация механизма блокировок в мониторе транзакций

### Внесенные изменения

1. **Модификация метода `processTransaction` в `TonTransactionMonitor`**:
   - Добавлена проверка и пропуск транзакций с статусом 'processing'
   - Реализовано использование методов `lockTransaction` и `unlockTransaction` из `TransactionRepository`
   - Добавлен блок `try-finally` для гарантированной разблокировки транзакций в случае сбоев
   - Новые транзакции сохраняются сразу со статусом 'processing' вместо 'pending'
   - Улучшен механизм обработки ошибок с обязательной разблокировкой транзакций

2. **Обновление метода `checkTransactionByHash` в `TonTransactionMonitor`**:
   - Добавлена проверка и пропуск транзакций с статусами 'processed' и 'processing'
   - Реализована разблокировка транзакций при ошибках проверки
   - Добавлена обработка случая, когда транзакция есть в БД, но не найдена в блокчейне

3. **Исправления в `TransactionRepository`**:
   - Корректная обработка ошибок TypeScript в методах блокировки и разблокировки

### Результаты

Реализованный механизм блокировок обеспечивает:

1. **Атомарность операций** — транзакция не может быть обработана двумя экземплярами сервиса одновременно
2. **Надежное восстановление** — транзакции не "застревают" в статусе 'processing' даже при аварийном завершении сервиса
3. **Улучшенную отказоустойчивость** — гарантированная разблокировка транзакций в любом сценарии
4. **Корректную работу в распределенной среде** — несколько экземпляров сервиса могут работать одновременно без конфликтов

Данная реализация позволяет безопасно масштабировать сервис и запускать несколько экземпляров для обработки транзакций, обеспечивая корректную работу даже при внезапном прерывании процессов. 