# Анализ ошибки "Unknown Error" в Fragment API

## [2024-07-17 18:30] Исследование ошибки "Unknown Error" в Fragment API

### Контекст проблемы

При попытке покупки 50 звезд Telegram для пользователя @skulidropek система получает ошибку "Unknown error" от Fragment API во время вызова метода `getBuyStarsLinkAsync`. Вот схема процесса, который приводит к ошибке:

```
Инициализация покупки -> Поиск пользователя -> Инициализация запроса (OK) -> Получение данных транзакции (ОШИБКА)
```

### Анализ логов

1. Транзакция успешно инициализирована в БД и заблокирована для обработки
2. Курс обмена получен успешно: 270.71 звезд за 1 TON
3. Пользователь @skulidropek успешно найден в системе Fragment
4. Запрос на покупку 50 звезд успешно инициализирован (reqId: wbSle3mpxJMozgL4_muT4U6h)
5. **Критическая ошибка**: Метод `getBuyStarsLinkAsync` вернул ответ с ошибкой:
   ```json
   {"ok":false,"error":"Unknown error","transaction":{"messages":[]}}
   ```

### Расследование причин

Согласно коду в `fragmentApiClient.ts`, клиент при получении ответа с полем `error` возвращает объект с флагом `ok: false` и текстом ошибки. Это приводит к выбросу исключения в методе `purchaseStarsAsync` класса `FragmentStarsPurchaseService`.

#### Возможные причины ошибки:

1. **Проблемы с авторизацией**: 
   - Устаревшие или недействительные куки (stel_ssid, stel_token, stel_ton_token)
   - Истек срок действия сессии пользователя

2. **Проблемы с API Fragment**:
   - Устаревший API_HASH (значение хеша может регулярно меняться)
   - Изменения в API Fragment, не учтенные в текущей реализации клиента

3. **Недостаточно средств**:
   - Возможно, баланс кошелька недостаточен для покупки запрошенного количества звезд

4. **Ограничения API**:
   - Ограничение на количество запросов (rate limiting)
   - Временное отключение функциональности покупки звезд

### Техническая диагностика

Проблема возникает в методе `getBuyStarsLinkAsync` класса `FragmentApiClient`, который отправляет POST-запрос к endpoint `/api` с параметрами:
- method: getBuyStarsLink
- id: wbSle3mpxJMozgL4_muT4U6h (ID запроса, полученный на этапе инициализации)
- account: {информация о кошельке} (включая публичный ключ и адрес)
- device: {информация об устройстве}
- show_sender: 1
- hash: {API_HASH из конфигурации}

Ответ Fragment API указывает на неизвестную ошибку без дополнительных деталей, что осложняет диагностику.

## Рекомендуемые действия по устранению

### 1. Проверка валидности авторизации

Необходимо проверить валидность авторизационных куки и API хеша:

```bash
# Пример запроса для проверки авторизации
curl 'https://fragment.com/api' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  -b 'stel_ssid=CURRENT_VALUE; stel_token=CURRENT_VALUE; stel_ton_token=CURRENT_VALUE; stel_dt=-240' \
  --data-raw 'hash=CURRENT_API_HASH&method=updateStarsBuyState&mode=new'
```

### 2. Обновление аутентификационных данных

Если куки устарели:

1. Авторизоваться на Fragment.com через браузер
2. Извлечь новые значения куки из DevTools браузера
3. Обновить значения в конфигурации:
   - FRAGMENT_COOKIE_STEL_SSID
   - FRAGMENT_COOKIE_STEL_TOKEN
   - FRAGMENT_COOKIE_STEL_TON_TOKEN

### 3. Обновление API хеша

Получить актуальный API хеш с сайта Fragment:

1. Открыть Fragment.com в браузере
2. В DevTools открыть вкладку Network
3. Найти запросы к `/api` и извлечь параметр `hash`
4. Обновить значение FRAGMENT_API_HASH в конфигурации

### 4. Расширение обработки ошибок

Для более детального анализа ошибок Fragment API рекомендуется:

1. Включить более подробное логирование ответов API
2. Добавить проверку баланса перед инициализацией покупки
3. Реализовать механизм автоматического обновления куки и API хеша

### 5. Тестирование с минимальным набором звезд

Попробовать выполнить операцию с минимальным количеством звезд (например, 10) для проверки работоспособности API Fragment.

## ASCII Диаграмма процесса

```
1. Инициализация → 2. Поиск пользователя → 3. Инициализация запроса → 4. Получение данных транзакции
   [БД: locked]           [OK: @skulidropek]      [OK: reqId получен]        [ОШИБКА: Unknown error]
                                                          ↓
                                                   Текущая точка сбоя
```

## [2024-07-17 19:15] Конкретное решение и рекомендации

После анализа конфигурации и кода, я пришел к выводу, что причина проблемы скорее всего в устаревших аутентификационных данных для Fragment API. Текущие значения в конфигурации:

```
FRAGMENT_API_HASH=6bcc4463359ef07914
FRAGMENT_COOKIE_STEL_SSID=489911dfdbd93c4584_3250221760863106958
FRAGMENT_COOKIE_STEL_TOKEN=5077a765ff7cc8cb379de1d8fc3399335077a77f5077a7042a991d9e585d6cd06d530
FRAGMENT_COOKIE_STEL_TON_TOKEN=ESqoicU6O1eikCeM3ym4txeO1ryRjtZpTRstOLsl91rlfLjVeL7eQa3HIrhdKwkP2VcLrcjX8Ozn4HFo71vt2hWVv_TPQpXn6i_5Cr3qGslLDPiuBco5tmB_rveV5NYIolrNZ_-2enY518uXKi6aowzm8Rth_Une_6exNw5My4X6UsB9seVUCFzv-dAHVgKOm5SacBvD
```

### Рекомендации для немедленного исправления:

1. **Обновите авторизационные данные**:
   ```bash
   # Обновите .env файл с новыми данными
   sed -i 's/FRAGMENT_API_HASH=.*/FRAGMENT_API_HASH=НОВОЕ_ЗНАЧЕНИЕ/' .env
   sed -i 's/FRAGMENT_COOKIE_STEL_SSID=.*/FRAGMENT_COOKIE_STEL_SSID=НОВОЕ_ЗНАЧЕНИЕ/' .env
   sed -i 's/FRAGMENT_COOKIE_STEL_TOKEN=.*/FRAGMENT_COOKIE_STEL_TOKEN=НОВОЕ_ЗНАЧЕНИЕ/' .env
   sed -i 's/FRAGMENT_COOKIE_STEL_TON_TOKEN=.*/FRAGMENT_COOKIE_STEL_TON_TOKEN=НОВОЕ_ЗНАЧЕНИЕ/' .env
   ```

2. **Добавьте проверку валидности сессии** в код `fragmentApiClient.ts`:
   ```typescript
   public async checkSessionValidAsync(): Promise<boolean> {
     try {
       // Простой запрос для проверки валидности сессии
       const response = await this.updatePurchaseStateAsync("test", "new", "");
       return response.ok;
     } catch (error) {
       console.error("[FragmentAPI] Сессия недействительна:", (error as Error).message);
       return false;
     }
   }
   ```

3. **Модифицируйте метод `getBuyStarsLinkAsync`** для лучшей обработки ошибок:
   ```typescript
   // В начале метода getBuyStarsLinkAsync добавьте:
   if (!(await this.checkSessionValidAsync())) {
     console.error("[FragmentAPI] Недействительная сессия. Необходимо обновить куки и API хеш");
     return {
       ok: false,
       error: "Недействительная сессия. Пожалуйста, обновите авторизационные данные",
       transaction: { messages: [] }
     };
   }
   ```

4. **Временное решение** - перезапустите процесс покупки с новыми авторизационными данными:
   ```bash
   # Пример команды для повторного запуска
   node dist/Program.js skulidropek 50
   ```

### Долгосрочные рекомендации для улучшения надежности:

1. **Механизм автоматического обновления сессии**:
   - Реализовать процесс авторизации через API Fragment
   - Создать инструменты для автоматического обновления куки
   - Хранить несколько наборов куки для резервирования

2. **Мониторинг фейлов авторизации**:
   - Добавить счетчик ошибок авторизации
   - Настроить оповещения при превышении порога ошибок
   - Создать механизм автоматического восстановления

3. **Детальное логирование HTTP запросов и ответов**:
   - Включить логирование заголовков (без сессионных данных)
   - Создать инструменты для анализа частых причин отказов
   - Настроить ротацию логов для долгосрочного анализа

4. **Система ротации API хешей**:
   - Создать базу данных известных рабочих API хешей
   - Реализовать механизм автоматического переключения при ошибке
   - Установить интервал обновления хешей

## Итоговое заключение

Ошибка "Unknown error" в Fragment API с высокой вероятностью связана с устаревшими авторизационными данными. Рекомендуется обновить куки и API хеш через процесс авторизации на Fragment.com, извлекая новые значения из браузера с использованием инструментов разработчика. 