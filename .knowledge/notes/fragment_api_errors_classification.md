# Классификация ошибок Fragment API

## [2024-07-17 19:45] Систематизация ошибок Fragment API

### Типы ошибок Fragment API

Fragment API может возвращать различные типы ошибок, которые можно классифицировать для более эффективной обработки и устранения проблем:

#### 1. Ошибки авторизации

| Код ошибки               | Описание                                        | Рекомендации по устранению                        |
|--------------------------|--------------------------------------------------|--------------------------------------------------|
| `Unknown error`          | Часто связан с недействительными куками или хешем | Обновить куки и API hash                          |
| `Invalid session`        | Сессия истекла или недействительна              | Повторно авторизоваться и получить новые куки     |
| `Authorization required` | Отсутствуют необходимые авторизационные данные  | Проверить наличие всех необходимых куки           |

#### 2. Ошибки API параметров

| Код ошибки                | Описание                                        | Рекомендации по устранению                         |
|---------------------------|--------------------------------------------------|---------------------------------------------------|
| `Invalid hash`            | Неверный или устаревший API hash                | Извлечь актуальный hash из запросов в DevTools     |
| `Invalid device info`     | Неверная или неполная информация об устройстве  | Обновить структуру deviceInfo в коде               |
| `Invalid recipient`       | Получатель не найден или недействителен         | Проверить существование пользователя               |

#### 3. Ошибки операций с TON

| Код ошибки                  | Описание                                        | Рекомендации по устранению                      |
|-----------------------------|--------------------------------------------------|------------------------------------------------|
| `Insufficient funds`        | Недостаточно средств для выполнения операции    | Пополнить баланс кошелька                       |
| `Invalid wallet address`    | Неверный адрес кошелька                         | Проверить и исправить адрес кошелька            |
| `Transaction failed`        | Ошибка при выполнении транзакции               | Проверить логи транзакции и состояние блокчейна |

#### 4. Ошибки состояния системы

| Код ошибки                | Описание                                          | Рекомендации по устранению                       |
|---------------------------|---------------------------------------------------|--------------------------------------------------|
| `Service unavailable`     | Сервис временно недоступен                        | Повторить запрос позже                           |
| `Rate limit exceeded`     | Превышен лимит запросов                           | Уменьшить частоту запросов                       |
| `Maintenance mode`        | Система находится в режиме обслуживания           | Дождаться завершения технических работ           |

### Обработка "Unknown error" в нашем случае

Особая категория ошибок - это "Unknown error", который часто требует комплексного анализа. В нашем конкретном случае:

1. **Успешно прошли этапы**:
   - Инициализация в БД
   - Поиск пользователя
   - Инициализация запроса (получение reqId)

2. **Сбой произошел при**:
   - Получении данных транзакции через getBuyStarsLinkAsync

3. **Признаки проблемы авторизации**:
   - Ошибка возникает на этапе, требующем доступ к данным пользователя
   - API успешно принимает запрос, но отказывает в доступе к деталям транзакции
   - Куки не отвергаются на этапе инициализации, но не авторизуют детальный доступ

### Диагностические шаги для "Unknown error"

Для диагностики "Unknown error" рекомендуется:

1. **Проверка валидности сессии**:
   ```typescript
   async function checkSessionValidity() {
     try {
       const result = await fragmentClient.updatePurchaseStateAsync("test", "new", "");
       return result.ok;
     } catch (e) {
       return false;
     }
   }
   ```

2. **Проверка параметров запроса**:
   ```javascript
   // Проверка параметров, отправляемых в API
   console.log("API Hash:", apiHash);
   console.log("Account:", JSON.stringify(account).substr(0, 100) + "...");
   console.log("Device:", JSON.stringify(deviceInfo));
   ```

3. **Мониторинг запросов через браузер**:
   ```bash
   # Воспроизведение покупки в браузере и мониторинг через DevTools
   curl 'https://fragment.com/api' \
     -H 'Content-Type: application/x-www-form-urlencoded' \
     -b 'stel_ssid=VALUE; stel_token=VALUE; stel_ton_token=VALUE' \
     --data-raw 'hash=VALUE&method=getBuyStarsLink&id=ID&show_sender=1'
   ```

### Стратегия для повышения устойчивости к ошибкам

Для минимизации влияния подобных ошибок в будущем рекомендуется:

1. **Проактивное обновление авторизации**:
   - Регулярное обновление куки перед критическими операциями
   - Проверка валидности сессии перед каждым блоком связанных операций

2. **Многоуровневая обработка ошибок**:
   - Специфическая обработка для каждого типа ошибки
   - Предопределенные стратегии восстановления

3. **Мониторинг изменений API**:
   - Отслеживание успешности операций во времени
   - Автоматическое оповещение о снижении успешности операций

4. **Резервные аккаунты**:
   - Поддержка нескольких независимых аккаунтов для авторизации
   - Автоматическое переключение при недоступности основного аккаунта

## ASCII Диаграмма жизненного цикла запроса в Fragment API

```
                       +----------------+
                       | Инициализация  |
                       | запроса (init) |
                       +--------+-------+
                                |
                                v
+---------------+      +--------+-------+      +----------------+
| Обновление    |<---->| Проверка       |<---->| Получение      |
| статуса       |      | статуса        |      | данных         |
| (update state)|      | (check status) |      | (getBuyStarsLink)
+---------------+      +--------+-------+      +----------------+
                                |                      |
                                v                      v
                       +--------+-------+     +----------------+
                       | Подтверждение  |     | Отправка       |
                       | (confirm)      |     | транзакции     |
                       +----------------+     +----------------+
```

### Карта ошибок по стадиям

На каждой стадии могут возникать различные типы ошибок:

- **Инициализация запроса**: Invalid recipient, Service unavailable
- **Получение данных**: Unknown error, Invalid session, Invalid hash
- **Подтверждение**: Transaction failed, Invalid device info  
- **Проверка статуса**: Rate limit exceeded, Maintenance mode
- **Обновление статуса**: Invalid hash, Authorization required 